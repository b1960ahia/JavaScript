<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Loterias ‚Äî Analisador Avan√ßado (PWA)</title>
  <!-- PWA Meta Tags -->
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Analisador Loterias">
<link rel="apple-touch-icon" href="icone-192.png">

<!-- Theme Color para diferentes navegadores -->
<meta name="theme-color" content="#2196f3">
<meta name="msapplication-navbutton-color" content="#2196f3">
<meta name="apple-mobile-web-app-status-bar-style" content="#2196f3">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2196f3">
  <style>
    /* Reset / base */
    :root{--primary:#2196f3;--accent:#ff5722;--bg:#fbfbfd;--card:#fff}
    body { font-family: Arial, sans-serif; margin: 0; background:var(--bg); color:#111; }
    .container { max-width:1200px; margin:0 auto; padding:16px; }

    /* Header / Nav */
    header.app-header{background:linear-gradient(90deg, #f8fcff, #ffffff); border-bottom:1px solid rgba(0,0,0,0.04);}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;gap:12px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand h1{font-size:18px;margin:0}
    .nav-links{display:flex;gap:8px;align-items:center}
    .nav-links a{padding:8px 10px;border-radius:6px;text-decoration:none;color:var(--primary);font-weight:600}

    /* hamburger */
    .hamburger{display:inline-flex;flex-direction:column;gap:4px;width:44px;height:36px;justify-content:center;align-items:center;border:1px solid transparent;border-radius:8px;background:transparent;cursor:pointer}
    .hamburger span{display:block;width:22px;height:2px;background:var(--primary);border-radius:2px;transition:transform .18s,opacity .18s}
    .hamburger[aria-expanded="true"] span:nth-child(1){transform:translateY(6px) rotate(45deg)}
    .hamburger[aria-expanded="true"] span:nth-child(2){opacity:0}
    .hamburger[aria-expanded="true"] span:nth-child(3){transform:translateY(-6px) rotate(-45deg)}

    /* mobile nav panel */
    .mobile-nav{position:fixed;top:0;left:0;right:0;height:100vh;background:rgba(255,255,255,0.98);backdrop-filter:blur(4px);z-index:1200;transform:translateY(-100%);transition:transform .28s ease;display:flex;flex-direction:column;padding:20px}
    .mobile-nav.open{transform:translateY(0)}
    .mobile-nav .close-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .mobile-nav nav{display:flex;flex-direction:column;gap:8px}
    .mobile-nav a{padding:12px;border-radius:8px;text-decoration:none;color:#111;background:#f5f7fb}

    /* Page styles (kept from original, slightly reorganized) */
    .panel{background:var(--card);margin-top:14px;padding:12px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.04)}
    .filters{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    label{font-size:14px;margin-right:8px}
    input[type=number],select,input[type=date]{padding:6px 8px;border:1px solid #ddd;border-radius:4px}
    button{background:var(--primary);color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:600}
    button.secondary{background:#fff;color:var(--primary);border:1px solid var(--primary)}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:12px}
    .col{flex:1;min-width:260px}
    #loading{margin-top:10px;font-style:italic;color:#666}
    .stats-grid{display:grid;gap:8px;margin-bottom:16px}
    .stat-item{background:#e3f2fd;padding:8px;border-radius:6px;text-align:center;font-weight:700}
    .dezena{display:inline-flex;width:30px;height:30px;border-radius:50%;background:var(--primary);color:#fff;align-items:center;justify-content:center;margin:2px;font-weight:700}
    .dezena.highlight{background:var(--accent) !important}
    table{width:100%;border-collapse:collapse;margin-top:8px;font-size:13px}
    th,td{border:1px solid #eee;padding:6px;text-align:center}
    #graficoWrapper{overflow-x:auto;padding:8px}
    .jogo{margin:8px 0;padding:8px;border-radius:6px;background:linear-gradient(90deg,#fff,#fffaf0);display:flex;justify-content:space-between;align-items:center}
    .small{font-size:13px;color:#555}
    .progress{height:8px;background:#eee;border-radius:8px;overflow:hidden;margin-top:8px}
    .progress>i{display:block;height:100%;background:linear-gradient(90deg,#66bb6a,#43a047);width:0%;transition:width .2s}
    .controls-inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn-ghost{background:transparent;border:1px solid #ddd;padding:6px 10px;border-radius:6px;cursor:pointer}
    #heatmap{width:100%;overflow:auto}
    pre{background:#f7f7f8;padding:10px;border-radius:6px;overflow:auto}

    /* Responsive: show nav links on desktop, hamburger on small screens */
    @media (min-width:880px){
      .hamburger{display:none}
      .mobile-nav{display:none}
      .nav-links{display:flex}
    }
    @media (max-width:879px){
      .nav-links{display:none}
      .container{padding:12px}
    }
    
    /* Grid responsivo para estat√≠sticas */
    /* Mega-Sena (60 n√∫meros) */
    .stats-grid.megasena {
      grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
    }
    
    /* Lotof√°cil (25 n√∫meros) */
    .stats-grid.lotofacil {
      grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
    }
    
    /* Quina (80 n√∫meros) */
    .stats-grid.quina {
      grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
    }
    
    /* Lotomania (100 n√∫meros) */
    .stats-grid.lotomania {
      grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
    }

    /* Melhorias para o grid responsivo */
    @media (max-width: 600px) {
      .stats-grid {
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)) !important;
        gap: 6px;
      }
      
      .stat-item {
        padding: 6px 4px;
        font-size: 12px;
      }
      
      .stat-item div:first-child {
        font-size: 12px;
      }
      
      .stat-item div:last-child {
        font-size: 11px;
      }
    }

    /* Para telas maiores */
    @media (min-width: 1200px) {
      .stats-grid {
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)) !important;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header class="app-header">
    <div class="topbar container">
      <div class="brand">
        <button class="hamburger" id="hamburgerBtn" aria-label="Abrir menu" aria-expanded="false">
          <span></span><span></span><span></span>
        </button>
        <h1>üìä Loterias ‚Äî Analisador Avan√ßado</h1>
      </div>

      <div class="nav-links" role="navigation" aria-label="Navega√ß√£o principal">
        <a href="#estatisticas" data-target="estatisticas">Estat√≠sticas</a>
        <a href="#resultados" data-target="resultados">Resultados</a>
        <a href="#analise" data-target="analise">An√°lise</a>
        <a href="#heatmap" data-target="heatmap">Heatmap</a>
        <a href="#config" data-target="config">Config</a>
      </div>
    </div>

    <!-- mobile nav panel -->
    <div class="mobile-nav" id="mobileNav" aria-hidden="true">
      <div class="close-row">
        <strong>Menu</strong>
        <button id="closeNav" class="btn-ghost" aria-label="Fechar menu">Fechar</button>
      </div>
      <nav>
        <a href="#estatisticas" data-target="estatisticas">üìà Estat√≠sticas</a>
        <a href="#resultados" data-target="resultados">üéØ Resultados</a>
        <a href="#analise" data-target="analise">üîÆ An√°lise</a>
        <a href="#heatmap" data-target="heatmap">üî¨ Heatmap</a>
        <a href="#config" data-target="config">‚öôÔ∏è Configura√ß√µes</a>
      </nav>
    </div>
  </header>

  <main class="container" id="mainContent">

    <section id="config" class="panel filters">
      <div class="controls-inline col">
        <label>Loteria:
          <select id="tipoLoteria">
            <option value="lotofacil">Lotof√°cil</option>
            <option value="megasena" selected>Mega-Sena</option>
            <option value="quina">Quina</option>
            <option value="lotomania">Lotomania</option>
          </select>
        </label>
        <label>Concurso In√≠cio: <input id="concursoInicio" type="number" min="1" style="width:100px"></label>
        <label>Concurso Fim: <input id="concursoFim" type="number" min="1" style="width:100px"></label>
        <button id="btnAtualizar">Atualizar</button>
      </div>

      <div class="controls-inline col" style="justify-content:flex-end">
        <label>Ou intervalo por data:</label>
        <input id="dataInicio" type="date">
        <input id="dataFim" type="date">
        <button id="btnFiltrarData" class="secondary">Aplicar Data</button>
      </div>

      <div style="width:100%; margin-top:8px; display:flex; gap:12px; align-items:center; justify-content:space-between;">
        <div class="small">Cache local (IndexedDB): <span id="cacheStatus">desconhecido</span></div>
        <div class="controls-inline">
          <button id="btnFetchAll" class="btn-ghost">Usar todos os concursos dispon√≠veis (1 ‚Üí √∫ltimo)</button>
          <button id="btnClearCache" class="btn-ghost">Limpar cache</button>
        </div>
      </div>

    </section>

    <div id="loading" class="small"></div>
    <div class="progress" style="display:none"><i id="progressBar"></i></div>

    <section id="estatisticas" class="panel">
      <h2>üìà Estat√≠sticas</h2>
      <div id="estatisticasGrid" class="stats-grid megasena"></div>
      <div id="graficoWrapper"><canvas id="grafico"></canvas></div>
    </section>

    <section id="resultados" class="panel">
      <h2>üéØ Resultados (lista)</h2>
      <div class="small">Clique em uma combina√ß√£o sugerida para destac√°-la na lista / gr√°fico.</div>
      <div id="tabelaResultados"></div>
      <div style="margin-top:8px;"><button id="btnExportCSV">Exportar concursos (CSV)</button></div>
    </section>

    <section id="analise" class="panel">
      <h2>üîÆ An√°lise Preditiva e Gera√ß√£o</h2>
      <div id="analiseProb" class="small"></div>

      <div style="margin-top:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <label>Quantidade de apostas: <input id="qtdApostas" type="number" value="5" min="1" max="50" style="width:70px"></label>
        <label>Tamanho aposta: <input id="tamanhoAposta" type="number" value="6" min="1" style="width:70px"></label>
        <button id="btnGerarOtimizadas">Gerar Combina√ß√µes Otimizadas</button>
        <button id="btnExportComb" class="secondary">Exportar combina√ß√µes (CSV)</button>
      </div>

      <div id="combinacoesOtimizadas"></div>
    </section>

    <section id="heatmap" class="panel">
      <h2>üî¨ Matriz de Coocorr√™ncia (visual)</h2>
      <div id="heatmap" class="small"></div>
    </section>

  </main>

  <script>
  /*************************************************************************
   *  IndexedDB simple wrapper (mantido)
   *************************************************************************/
  const DB_NAME = 'loterias_cache_v1';
  const DB_STORE = 'concurso_store';
  let dbPromise = null;

  function openDB() {
    if (dbPromise) return dbPromise;
    dbPromise = new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, 1);
      req.onupgradeneeded = (e) => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains(DB_STORE)) {
          db.createObjectStore(DB_STORE, { keyPath: 'key' });
        }
      };
      req.onsuccess = e => resolve(e.target.result);
      req.onerror = e => reject(e.target.error);
    });
    return dbPromise;
  }

  async function idbPut(key, value) {
    const db = await openDB();
    return new Promise((res, rej) => {
      const tx = db.transaction(DB_STORE, 'readwrite');
      const store = tx.objectStore(DB_STORE);
      store.put({ key, value, ts: Date.now() });
      tx.oncomplete = () => res(true);
      tx.onerror = e => rej(e);
    });
  }

  async function idbGet(key) {
    const db = await openDB();
    return new Promise((res, rej) => {
      const tx = db.transaction(DB_STORE, 'readonly');
      const store = tx.objectStore(DB_STORE);
      const r = store.get(key);
      r.onsuccess = () => res(r.result ? r.result.value : null);
      r.onerror = e => rej(e);
    });
  }

  async function idbClear() {
    const db = await openDB();
    return new Promise((res, rej) => {
      const tx = db.transaction(DB_STORE,'readwrite');
      tx.objectStore(DB_STORE).clear();
      tx.oncomplete = () => res(true);
      tx.onerror = e => rej(e);
    });
  }

  async function idbKeysPrefix(prefix) {
    const db = await openDB();
    return new Promise((res, rej) => {
      const tx = db.transaction(DB_STORE,'readonly');
      const store = tx.objectStore(DB_STORE);
      const req = store.openCursor();
      const keys = [];
      req.onsuccess = e => {
        const cur = e.target.result;
        if (!cur) { res(keys); return; }
        if (cur.key && cur.key.startsWith(prefix)) keys.push(cur.key);
        cur.continue();
      };
      req.onerror = e => rej(e);
    });
  }

  /*************************************************************************
   *  Config Loterias
   *************************************************************************/
  const cfgLoterias = {
    lotofacil: { nome: 'Lotof√°cil', max:25, api:'lotofacil', defaultSize:15 },
    megasena:  { nome: 'Mega-Sena', max:60, api:'megasena', defaultSize:6 },
    quina:     { nome: 'Quina', max:80, api:'quina', defaultSize:5 },
    lotomania: { nome: 'Lotomania', max:100, api:'lotomania', defaultSize:50 }
  };

  let cfgAtual = cfgLoterias['megasena'];
  let ultimosSorteios = [];
  let statsGlobais = [];
  let coocMatrix = [];
  let ultimoScores = [];

  // DOM
  const tipoSel = document.getElementById('tipoLoteria');
  const inicioInput = document.getElementById('concursoInicio');
  const fimInput = document.getElementById('concursoFim');
  const dataInicio = document.getElementById('dataInicio');
  const dataFim = document.getElementById('dataFim');
  const btnAtualizar = document.getElementById('btnAtualizar');
  const btnFiltrarData = document.getElementById('btnFiltrarData');
  const btnFetchAll = document.getElementById('btnFetchAll');
  const btnClearCache = document.getElementById('btnClearCache');
  const loadingText = document.getElementById('loading');
  const progressBar = document.getElementById('progressBar');
  const progressWrap = document.querySelector('.progress');
  const estatisticasGrid = document.getElementById('estatisticasGrid');
  const tabelaResultados = document.getElementById('tabelaResultados');
  const graficoCanvas = document.getElementById('grafico');
  const analiseProb = document.getElementById('analiseProb');
  const combinacoesDiv = document.getElementById('combinacoesOtimizadas');
  const heatmapDiv = document.getElementById('heatmap');
  const btnExportCSV = document.getElementById('btnExportCSV');
  const btnGerarOtimizadas = document.getElementById('btnGerarOtimizadas');
  const btnExportComb = document.getElementById('btnExportComb');
  const qtdApostasInput = document.getElementById('qtdApostas');
  const tamanhoApostaInput = document.getElementById('tamanhoAposta');

  // Header / nav controls
  const hamburgerBtn = document.getElementById('hamburgerBtn');
  const mobileNav = document.getElementById('mobileNav');
  const closeNav = document.getElementById('closeNav');

  tipoSel.addEventListener('change', () => {
    cfgAtual = cfgLoterias[tipoSel.value];
    tamanhoApostaInput.value = cfgAtual.defaultSize;
    atualizarCacheStatus();
  });

  btnAtualizar.addEventListener('click', carregarIntervalo);
  btnFiltrarData.addEventListener('click', filtrarPorData);
  btnFetchAll.addEventListener('click', fetchAllConcursos);
  btnClearCache.addEventListener('click', async () => {
    if (!confirm('Limpar cache local dos concursos?')) return;
    await idbClear();
    atualizarCacheStatus();
    alert('Cache limpo.');
  });

  btnExportCSV.addEventListener('click', exportConcursosCSV);
  btnGerarOtimizadas.addEventListener('click', () => gerarCombinacoesOtimizadas());
  btnExportComb.addEventListener('click', exportCombCSV);

  // Chart
  let chartInstance = null;

  /*************************************************************************
   *  Fetch helpers (Caixa API)
   *************************************************************************/
  async function fetchConcurso(tipoApi, numero) {
    const url = `https://servicebus2.caixa.gov.br/portaldeloterias/api/${tipoApi}/${numero}`;
    const resp = await fetch(url, { headers: { "Accept": "application/json, text/plain, */*" } });
    if (!resp.ok) throw new Error(`Erro ${resp.status}`);
    return await resp.json();
  }

  async function fetchUltimoConcurso(tipoApi) {
    const url = `https://servicebus2.caixa.gov.br/portaldeloterias/api/${tipoApi}`;
    const resp = await fetch(url, { headers: { "Accept": "application/json, text/plain, */*" } });
    if (!resp.ok) throw new Error(`Erro ${resp.status}`);
    return await resp.json();
  }

  /*************************************************************************
   *  Cache helpers + util
   *************************************************************************/
  function cacheKey(tipo, numero) { return `${tipo}:${numero}`; }

  async function carregarIntervalo() {
    try {
      cfgAtual = cfgLoterias[tipoSel.value];
      let inicio = parseInt(inicioInput.value);
      let fim = parseInt(fimInput.value);

      if (!inicio || !fim) {
        const ultimo = await fetchUltimoConcurso(cfgAtual.api);
        fim = ultimo.numero;
        inicio = Math.max(1, fim - 20);
        inicioInput.value = inicio;
        fimInput.value = fim;
      }

      if (inicio > fim) { alert('Concurso in√≠cio > concurso fim'); return; }

      loadingText.innerText = `Buscando concursos ${inicio} ‚Üí ${fim} ...`;
      progressWrap.style.display = 'block';
      progressBar.style.width = '0%';

      const arr = [];
      const total = fim - inicio + 1;
      let loaded = 0;
      
      for (let n = inicio; n <= fim; n++) {
        const key = cacheKey(cfgAtual.api, n);
        let data = await idbGet(key);
        
        if (!data) {
          try {
            const raw = await fetchConcurso(cfgAtual.api, n);
            // CORRE√á√ÉO: Tratamento espec√≠fico para Lotomania
            let listaDezenas = raw.listaDezenas || [];
            
            // Se for Lotomania e n√£o tiver listaDezenas, tentar outros campos
            if (cfgAtual.api === 'lotomania' && (!listaDezenas || listaDezenas.length === 0)) {
              listaDezenas = raw.dezenas || raw.numeros || [];
            }
            
            data = { 
              numero: raw.numero, 
              dataApuracao: raw.dataApuracao, 
              listaDezenas: listaDezenas 
            };
            await idbPut(key, data);
          } catch (err) {
            console.warn('Erro fetch concurso', n, err);
            data = null;
          }
        }
        
        if (data) {
          // CORRE√á√ÉO: Processamento seguro das dezenas
          const dezenasProcessadas = (data.listaDezenas || [])
            .map(x => {
              const num = parseInt(x, 10);
              return isNaN(num) ? null : num;
            })
            .filter(x => x !== null && x >= 0 && x <= cfgAtual.max)
            .sort((a, b) => a - b);
          
          arr.push({ 
            concurso: data.numero, 
            data: data.dataApuracao, 
            dezenas: dezenasProcessadas 
          });
        }
        
        loaded++;
        progressBar.style.width = `${Math.round((loaded / total) * 100)}%`;
      }
      
      progressWrap.style.display = 'none';
      loadingText.innerText = '';
      ultimosSorteios = arr.sort((a, b) => a.concurso - b.concurso);
      processarDadosEExibir();
      atualizarCacheStatus();
      
    } catch (e) {
      console.error('Erro no carregamento:', e);
      alert('Erro ao carregar intervalo. Veja console.');
      progressWrap.style.display = 'none';
      loadingText.innerText = 'Erro no carregamento';
    }
  }

  async function filtrarPorData() {
    const di = dataInicio.value;
    const df = dataFim.value;
    if (!di || !df) { alert('Informe data in√≠cio e fim'); return; }
    const start = new Date(di);
    const end = new Date(df);
    if (start > end) { alert('Data in√≠cio maior que fim'); return; }

    cfgAtual = cfgLoterias[tipoSel.value];
    const keys = await idbKeysPrefix(cfgAtual.api + ':');
    let arr = [];
    for (const k of keys) {
      const val = await idbGet(k);
      if (!val) continue;
      const d = new Date(val.dataApuracao);
      if (d >= start && d <= end) {
        // CORRE√á√ÉO: Processamento seguro das dezenas
        const dezenasProcessadas = (val.listaDezenas || [])
          .map(x => {
            const num = parseInt(x, 10);
            return isNaN(num) ? null : num;
          })
          .filter(x => x !== null && x >= 0 && x <= cfgAtual.max)
          .sort((a, b) => a - b);
        
        arr.push({ 
          concurso: val.numero, 
          data: val.dataApuracao, 
          dezenas: dezenasProcessadas 
        });
      }
    }

    if (arr.length === 0) {
      const ultimo = await fetchUltimoConcurso(cfgAtual.api);
      const fim = ultimo.numero;
      const inicio = Math.max(1, fim - 400);
      loadingText.innerText = 'Buscando concursos para filtrar por data (pode demorar)...';
      progressWrap.style.display = 'block';
      progressBar.style.width = '0%';
      const temp = [];
      let loaded = 0;
      for (let n = inicio; n <= fim; n++) {
        let raw = await idbGet(cacheKey(cfgAtual.api, n));
        if (!raw) {
          try { 
            raw = await fetchConcurso(cfgAtual.api, n); 
            await idbPut(cacheKey(cfgAtual.api, n), raw); 
          } catch {}
        }
        if (raw) {
          const dd = new Date(raw.dataApuracao);
          if (dd >= start && dd <= end) {
            // CORRE√á√ÉO: Processamento seguro das dezenas
            const dezenasProcessadas = (raw.listaDezenas || [])
              .map(x => {
                const num = parseInt(x, 10);
                return isNaN(num) ? null : num;
              })
              .filter(x => x !== null && x >= 0 && x <= cfgAtual.max)
              .sort((a, b) => a - b);
            
            temp.push({ 
              concurso: raw.numero, 
              data: raw.dataApuracao, 
              dezenas: dezenasProcessadas 
            });
          }
        }
        loaded++;
        progressBar.style.width = `${Math.round((loaded/(fim-inicio+1))*100)}%`;
      }
      progressWrap.style.display = 'none';
      loadingText.innerText = '';
      arr = temp;
    }

    ultimosSorteios = arr.sort((a,b)=>a.concurso-b.concurso);
    processarDadosEExibir();
    atualizarCacheStatus();
  }

  async function fetchAllConcursos() {
    if (!confirm('Isto ir√° baixar muitos concursos (um por um) e armazenar em seu navegador. Deseja continuar?')) return;
    cfgAtual = cfgLoterias[tipoSel.value];
    const ultimo = await fetchUltimoConcurso(cfgAtual.api);
    const fim = ultimo.numero;
    const inicio = 1;
    loadingText.innerText = `Baixando todos os concursos 1 ‚Üí ${fim} (cache progressivo). Pode demorar.`;
    progressWrap.style.display = 'block';
    const batch = 25;
    let loaded = 0;

    for (let s = inicio; s <= fim; s += batch) {
      const promises = [];
      for (let n = s; n < s + batch && n <= fim; n++) {
        const key = cacheKey(cfgAtual.api, n);
        promises.push((async () => {
          const existing = await idbGet(key);
          if (!existing) {
            try {
              const raw = await fetchConcurso(cfgAtual.api, n);
              // CORRE√á√ÉO: Tratamento espec√≠fico para Lotomania
              let listaDezenas = raw.listaDezenas || [];
              
              // Se for Lotomania e n√£o tiver listaDezenas, tentar outros campos
              if (cfgAtual.api === 'lotomania' && (!listaDezenas || listaDezenas.length === 0)) {
                listaDezenas = raw.dezenas || raw.numeros || [];
              }
              
              await idbPut(key, { 
                numero: raw.numero, 
                dataApuracao: raw.dataApuracao, 
                listaDezenas: listaDezenas 
              });
            } catch (err) {
              console.warn('Erro ao buscar concurso', n, err);
            }
          }
        })());
      }
      await Promise.all(promises);
      loaded = Math.min(fim, s + batch - 1);
      progressBar.style.width = `${Math.round((loaded/fim) * 100)}%`;
    }

    progressWrap.style.display = 'none';
    loadingText.innerText = 'Conclu√≠do download total (cache). Voc√™ pode agora filtrar ou usar "Carregar intervalo".';
    atualizarCacheStatus();
  }

  async function atualizarCacheStatus() {
    const keys = await idbKeysPrefix((cfgLoterias[tipoSel.value].api || '') + ':');
    document.getElementById('cacheStatus').innerText = keys.length ? `${keys.length} itens em cache` : 'vazio';
  }

  /*************************************************************************
   *  Processamento de dados
   *************************************************************************/
  function processarDadosEExibir() {
    if (!ultimosSorteios || ultimosSorteios.length === 0) {
      estatisticasGrid.innerHTML = '<div class="small">Nenhum concurso carregado.</div>';
      tabelaResultados.innerHTML = '';
      analiseProb.innerHTML = '';
      combinacoesDiv.innerHTML = '';
      heatmapDiv.innerHTML = '';
      return;
    }
    
    const N = cfgAtual.max;
    const freq = Array(N).fill(0);
    const matrix = Array.from({length: N}, () => Array(N).fill(0));
    const total = ultimosSorteios.length;

    // Processar cada sorteio - CORRE√á√ÉO PARA LOTOMANIA
    ultimosSorteios.forEach(s => {
      // Garantir que as dezenas s√£o n√∫meros v√°lidos
      const dezenasValidas = s.dezenas
        .map(d => parseInt(d, 10))
        .filter(d => !isNaN(d) && d >= 1 && d <= N);
      
      dezenasValidas.forEach(d1 => {
        if (d1 >= 1 && d1 <= N) {
          freq[d1 - 1]++;
          dezenasValidas.forEach(d2 => {
            if (d2 >= 1 && d2 <= N && d1 !== d2) {
              matrix[d1 - 1][d2 - 1]++;
            }
          });
        }
      });
    });

    statsGlobais = freq;
    coocMatrix = matrix;

    // Calcular probabilidades e scores
    const p = freq.map(f => f / total);
    const p2 = matrix.map(l => l.map(v => v / total));
    const associacao = Array(N).fill(0);
    
    for (let i = 0; i < N; i++) {
      let soma = 0, cont = 0;
      for (let j = 0; j < N; j++) {
        if (i !== j && p[i] > 0 && p[j] > 0) { 
          soma += p2[i][j] / (p[i] * p[j]); 
          cont++; 
        }
      }
      associacao[i] = cont ? soma / cont : 1;
    }
    
    const scores = freq.map((f, i) => f * associacao[i]);
    ultimoScores = scores;

    renderEstatisticas(freq);
    renderResultados(ultimosSorteios);
    renderGrafico(freq);
    renderAnaliseSummary(total, freq, scores);
    renderHeatmap(matrix, freq);
  }

  /*************************************************************************
   *  Renderers
   *************************************************************************/
  function renderEstatisticas(freq) {
    const N = cfgAtual.max;
    
    // Atualizar classe CSS do grid baseado na loteria atual
    estatisticasGrid.className = `stats-grid ${tipoSel.value}`;
    
    let html = '';
    for (let i=0;i<N;i++){
      html += `<div class="stat-item"><div style="font-size:14px">${String(i+1).padStart(2,'0')}</div><div style="font-size:12px">${freq[i]}x</div></div>`;
    }
    estatisticasGrid.innerHTML = html;
  }

  function renderResultados(arr) {
    let html = `<table><tr><th>Concurso</th><th>Data</th><th>Dezenas</th></tr>`;
    arr.slice().reverse().forEach(s => {
      html += `<tr><td>${s.concurso}</td><td>${s.data}</td><td>${s.dezenas.map(d=>`<span class="dezena">${String(d).padStart(2,'0')}</span>`).join('')}</td></tr>`;
    });
    html += `</table>`;
    tabelaResultados.innerHTML = html;
  }

  function renderGrafico(freq) {
    const labels = freq.map((_,i)=>String(i+1).padStart(2,'0'));
    const data = freq;
    if (chartInstance) chartInstance.destroy();
    chartInstance = new Chart(graficoCanvas.getContext('2d'), {
      type:'bar',
      data:{ labels, datasets:[{ label:'Frequ√™ncia', data, backgroundColor:'#2196f3' }]},
      options:{ responsive:true, plugins:{ legend:{display:false} } }
    });
  }

  function renderAnaliseSummary(total, freq, scores) {
    const N = cfgAtual.max;
    const arr = scores.map((s,i)=>({num:i+1,score:s,freq:freq[i]}));
    arr.sort((a,b)=>b.score-a.score);
    const topk = arr.slice(0,cfgAtual.defaultSize).map(x=>x.num);

    let html = `<div><b>Concursos analisados:</b> ${total}</div>`;
    html += `<div style="margin-top:8px;"><b>Dezenas mais prov√°veis (score ajustado):</b> ${topk.map(d=>`<span class="dezena highlight">${String(d).padStart(2,'0')}</span>`).join(' ')}</div>`;
    analiseProb.innerHTML = html;
  }

  function renderHeatmap(matrix, freq) {
    const N = cfgAtual.max;
    const total = ultimosSorteios.length;
    const pairs = [];
    for (let i=0;i<N;i++){
      for (let j=i+1;j<N;j++){
        const val = (matrix[i][j] + matrix[j][i]) / total;
        pairs.push({ a:i+1, b:j+1, v: val });
      }
    }
    pairs.sort((a,b)=>b.v - a.v);
    const top = pairs.slice(0,30);
    let html = `<div><b>Top pares por coocorr√™ncia (frequ√™ncia conjunta)</b></div><div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;">`;
    top.forEach(p => html += `<div style="padding:6px;border-radius:6px;background:#fff">${String(p.a).padStart(2,'0')}-${String(p.b).padStart(2,'0')} <div class="small"> ${p.v.toFixed(3)}</div></div>`);
    html += `</div>`;
    heatmapDiv.innerHTML = html;
  }

  /*************************************************************************
   *  Gerador autom√°tico de combina√ß√µes otimizadas
   *************************************************************************/
  function sampleWithoutReplacementWeighted(weights, k) {
    const items = weights.map(x=>({ ...x }));
    const chosen = [];
    for (let r=0;r<k && items.length>0;r++){
      const sum = items.reduce((s,it)=>s+it.w,0);
      if (sum <= 0) {
        const idx = Math.floor(Math.random()*items.length);
        chosen.push(items[idx].num);
        items.splice(idx,1);
        continue;
      }
      let x = Math.random() * sum;
      let idx = 0;
      while (x > items[idx].w && idx < items.length-1) {
        x -= items[idx].w;
        idx++;
      }
      chosen.push(items[idx].num);
      items.splice(idx,1);
    }
    return chosen.sort((a,b)=>a-b);
  }

  function calcularScoreComb(comb) {
    const N = cfgAtual.max;
    const idxs = comb.map(d=>d-1);
    const sumInd = idxs.reduce((s,i)=>s + (ultimoScores[i] || 0), 0);
    let sumPairs = 0, pairs=0;
    for (let i=0;i<idxs.length;i++){
      for (let j=i+1;j<idxs.length;j++){
        const v = (coocMatrix[idxs[i]][idxs[j]] + coocMatrix[idxs[j]][idxs[i]]) / 2;
        sumPairs += v;
        pairs++;
      }
    }
    const meanPairs = pairs ? (sumPairs / pairs) : 0;
    let gapsScore = 0;
    for (let i=1;i<comb.length;i++) gapsScore += Math.abs(comb[i] - comb[i-1]);
    const diversity = gapsScore / comb.length;
    const alpha = 1.0, beta = 0.6, gamma = 0.02;
    const score = alpha * sumInd + beta * meanPairs - gamma * (20 - diversity);
    return score;
  }

  async function gerarCombinacoesOtimizadas() {
    if (!ultimosSorteios.length) { alert('Carregue um intervalo primeiro.'); return; }
    const qtd = Math.max(1, Math.min(50, parseInt(qtdApostasInput.value) || 5));
    const k = Math.max(1, parseInt(tamanhoApostaInput.value) || cfgAtual.defaultSize);
    const N = cfgAtual.max;
    const base = ultimoScores.map((s,i)=>({ num: i+1, w: Math.max(0.00001, s) }));
    const candidates = [];
    const tries = Math.max(200, qtd * 200);
    for (let t=0;t<tries;t++){
      const comb = sampleWithoutReplacementWeighted(base, k);
      const key = comb.join(',');
      const sc = calcularScoreComb(comb);
      candidates.push({ comb, score: sc, key });
    }
    const map = new Map();
    candidates.sort((a,b)=>b.score - a.score);
    for (const c of candidates) {
      if (map.size >= qtd) break;
      if (!map.has(c.key)) map.set(c.key, c);
    }
    const top = Array.from(map.values()).slice(0,qtd);
    combinacoesDiv.innerHTML = '';
    top.forEach((t,i) => {
      const div = document.createElement('div');
      div.className = 'jogo';
      div.innerHTML = `<div><b>Jogo ${i+1}</b> &nbsp; ${t.comb.map(d=>`<span class="dezena">${String(d).padStart(2,'0')}</span>`).join(' ')}</div>
                       <div class="small">score: ${t.score.toFixed(4)}</div>`;
      div.addEventListener('click', ()=> highlightCombination(t.comb));
      combinacoesDiv.appendChild(div);
    });
  }

  function highlightCombination(comb) {
    const html = `<table><tr><th>Concurso</th><th>Data</th><th>Dezenas</th></tr>` +
      ultimosSorteios.slice().reverse().map(s => {
        const str = s.dezenas.map(d => {
          const cls = comb.includes(d) ? 'dezena highlight' : 'dezena';
          return `<span class="${cls}">${String(d).padStart(2,'0')}</span>`;
        }).join('');
        return `<tr><td>${s.concurso}</td><td>${s.data}</td><td>${str}</td></tr>`;
      }).join('') + `</table>`;
    tabelaResultados.innerHTML = html;
    if (chartInstance) {
      chartInstance.data.datasets[0].backgroundColor = chartInstance.data.labels.map((lab,i)=> comb.includes(i+1) ? '#ff5722' : '#2196f3');
      chartInstance.update();
      setTimeout(()=> {
        chartInstance.data.datasets[0].backgroundColor = '#2196f3';
        chartInstance.update();
        renderResultados(ultimosSorteios);
      }, 6000);
    }
  }

  /*************************************************************************
   *  Export helpers
   *************************************************************************/
  function exportConcursosCSV() {
    if (!ultimosSorteios.length) { alert('Nada a exportar'); return; }
    let csv = 'concurso,data,dezenas\n';
    ultimosSorteios.forEach(s => {
      csv += `${s.concurso},"${s.data}","${s.dezenas.join(' ')}"\n`;
    });
    downloadText(csv, `${cfgAtual.api}_concursos_${Date.now()}.csv`);
  }

  function exportCombCSV() {
    const nodes = combinacoesDiv.querySelectorAll('.jogo');
    if (!nodes.length) { alert('Gere combina√ß√µes antes.'); return; }
    let csv = 'jogo,dezenas,score\n';
    nodes.forEach((n,i) => {
      const dez = Array.from(n.querySelectorAll('.dezena')).map(s => s.innerText).join(' ');
      const score = n.querySelector('.small')?.innerText.replace('score: ','') || '';
      csv += `${i+1},"${dez}",${score}\n`;
    });
    downloadText(csv, `${cfgAtual.api}_combinacoes_${Date.now()}.csv`);
  }

  function downloadText(text, filename) {
    const blob = new Blob([text], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; document.body.appendChild(a); a.click();
    setTimeout(()=> { URL.revokeObjectURL(url); a.remove(); }, 2000);
  }

  /*************************************************************************
   *  Mobile nav interactions
   *************************************************************************/
  function openMobileNav(){
    mobileNav.classList.add('open');
    mobileNav.setAttribute('aria-hidden','false');
    hamburgerBtn.setAttribute('aria-expanded','true');
  }
  function closeMobileNav(){
    mobileNav.classList.remove('open');
    mobileNav.setAttribute('aria-hidden','true');
    hamburgerBtn.setAttribute('aria-expanded','false');
  }
  hamburgerBtn.addEventListener('click', ()=>{
    const expanded = hamburgerBtn.getAttribute('aria-expanded') === 'true';
    if (expanded) closeMobileNav(); else openMobileNav();
  });
  closeNav.addEventListener('click', closeMobileNav);
  // close when click on a link and navigate to section
  mobileNav.querySelectorAll('a').forEach(a=>{
    a.addEventListener('click', (ev)=>{
      closeMobileNav();
      const t = a.getAttribute('data-target');
      const el = document.getElementById(t);
      if (el) setTimeout(()=> el.scrollIntoView({behavior:'smooth',block:'start'}), 250);
    });
  });
  // close on Escape
  document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeMobileNav(); });

  /*************************************************************************
   *  Inicializa√ß√£o
   *************************************************************************/
  (async () => {
    cfgAtual = cfgLoterias[tipoSel.value];
    tamanhoApostaInput.value = cfgAtual.defaultSize;
    await atualizarCacheStatus();
    if ('serviceWorker' in navigator) {
      try { navigator.serviceWorker.register('service-worker.js'); } catch(e){console.warn('SW reg fail',e);}    }
    try { await carregarIntervalo(); } catch(e) { console.warn('preload fail', e); }
  })();

  // Registro do Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('service-worker.js')
      .then(function(registration) {
        console.log('ServiceWorker registrado com sucesso: ', registration.scope);
        
        // Verifica se h√° uma nova vers√£o dispon√≠vel
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          console.log('Nova vers√£o do Service Worker encontrada!');
          
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              // Nova vers√£o dispon√≠vel, mostrar notifica√ß√£o para atualizar
              if (confirm('Nova vers√£o dispon√≠vel! Deseja atualizar?')) {
                newWorker.postMessage({ type: 'SKIP_WAITING' });
                window.location.reload();
              }
            }
          });
        });
      })
      .catch(function(error) {
        console.log('Falha no registro do ServiceWorker: ', error);
      });
  });

  // Ouvinte para atualiza√ß√µes
  let refreshing = false;
  navigator.serviceWorker.addEventListener('controllerchange', () => {
    if (!refreshing) {
      refreshing = true;
      window.location.reload();
    }
  });
}

// Fun√ß√£o para verificar se o app est√° instalado
function checkPWAInstall() {
  const isInstalled = window.matchMedia('(display-mode: standalone)').matches || 
                     window.navigator.standalone ||
                     document.referrer.includes('android-app://');
  
  if (isInstalled) {
    console.log('App executando como PWA instalado');
  }
}

// Verifica na carga inicial
checkPWAInstall();

  </script>
</body>
</html>