<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Analise JB Loto</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2196f3">
  <!-- PWA Meta Tags -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="JB Loto">
<meta name="mobile-web-app-capable" content="yes">
<meta name="msapplication-TileColor" content="#2196f3">
<meta name="msapplication-TileImage" content="/icon-144x144.png">
<meta name="msapplication-config" content="/browserconfig.xml">
<meta name="application-name" content="JB Loto">

<!-- Apple Touch Icons -->
<!-- CORRIGIDO -->
<link rel="apple-touch-icon" href="/JavaScript/LotoMenu/icon-192.png">
<link rel="apple-touch-icon" sizes="152x152" href="/JavaScript/LotoMenu/icon-192.png">
<link rel="apple-touch-icon" sizes="180x180" href="/JavaScript/LotoMenu/icon-192.png">
<link rel="apple-touch-icon" sizes="167x167" href="/JavaScript/LotoMenu/icon-192.png">

<!-- E tamb√©m no manifest (j√° corrigido acima) -->

<!-- Splash Screens (opcional) -->
<link rel="apple-touch-startup-image" href="/splash-640x1136.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
<link rel="apple-touch-startup-image" href="/splash-750x1334.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
<link rel="apple-touch-startup-image" href="/splash-1242x2208.png" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
  <style>
    /* (mantive seu CSS, pequenos ajustes visuais) */
    /* Estilos espec√≠ficos para PWA */
.pwa-mode body {
  padding-top: env(safe-area-inset-top);
  padding-bottom: env(safe-area-inset-bottom);
  padding-left: env(safe-area-inset-left);
  padding-right: env(safe-area-inset-right);
}

/* Melhorar visualiza√ß√£o em mobile quando instalado */
@media (display-mode: standalone) {
  body {
    user-select: none;
    -webkit-user-select: none;
  }
  
  .container {
    max-width: 100%;
    margin: 0 auto;
  }
}

/* Prevenir zoom em inputs em iOS */
@media (max-width: 768px) {
  input, select, textarea {
    font-size: 16px !important;
  }
}
    body { font-family: Arial, sans-serif; margin: 16px; background:#fbfbfd; color:#111; }
    .container { max-width:1200px; margin:0 auto; }
    h1 { margin-bottom:8px; }
    .filters { background:#fff; padding:12px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.06); display:flex; gap:12px; flex-wrap:wrap; align-items:center;}
    label { font-size:14px; margin-right:8px; }
    input[type=number], select, input[type=date] { padding:6px 8px; border:1px solid #ddd; border-radius:4px; }
    button { background:#2196f3; color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; font-weight:600; }
    button.secondary { background:#fff; color:#2196f3; border:1px solid #2196f3; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:12px; }
    .col { flex:1; min-width:260px; }
    #loading { margin-top:10px; font-style:italic; color:#666; }
    .panel { background:#fff; margin-top:14px; padding:12px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.04); }
    .stats { display:grid; gap:8px; grid-template-columns:repeat(auto-fit,minmax(60px,1fr)); }
    .stat-item { background:#e3f2fd; padding:8px; border-radius:6px; text-align:center; font-weight:700; }
    .dezena { display:inline-flex; width:30px; height:30px; border-radius:50%; background:#2196f3; color:#fff; align-items:center; justify-content:center; margin:2px; font-weight:700;}
    .dezena.highlight { background:#ff5722 !important; }
    table { width:100%; border-collapse:collapse; margin-top:8px; font-size:13px; }
    th, td { border:1px solid #eee; padding:6px; text-align:center; }
    #graficoWrapper { overflow-x:auto; padding:8px; }
    #combinacoesOtimizadas .jogo { margin:8px 0; padding:8px; border-radius:6px; background:linear-gradient(90deg,#fff,#fffaf0); display:flex; justify-content:space-between; align-items:center; }
    .small { font-size:13px; color:#555; }
    .progress { height:8px; background:#eee; border-radius:8px; overflow:hidden; margin-top:8px; }
    .progress > i { display:block; height:100%; background:linear-gradient(90deg,#66bb6a,#43a047); width:0%; transition:width .2s; }
    .controls-inline { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .btn-ghost { background:transparent; border:1px solid #ddd; padding:6px 10px; border-radius:6px; cursor:pointer; }
    #heatmap { width:100%; overflow:auto; }
    pre { background:#f7f7f8; padding:10px; border-radius:6px; overflow:auto; }
    input[type=number].small-num { width:80px; padding:6px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <h1>üìä Analise JB Loto</h1>

    <div class="panel filters">
      <div class="controls-inline col">
        <label>Loteria:
          <select id="tipoLoteria">
            <option value="lotofacil">Lotof√°cil</option>
            <option value="megasena" selected>Mega-Sena</option>
            <option value="quina">Quina</option>
            <option value="lotomania">Lotomania</option>
          </select>
        </label>
        <label>Concurso In√≠cio: <input id="concursoInicio" type="number" min="1" class="small-num"></label>
        <label>Concurso Fim: <input id="concursoFim" type="number" min="1" class="small-num"></label>
        <button id="btnAtualizar">Atualizar</button>
        <label style="margin-left:8px">√öltimos <input id="ultimosN" type="number" min="1" value="20" class="small-num"> concursos</label>
      </div>

      <div class="controls-inline col" style="justify-content:flex-end">
        <label>Ou intervalo por data:</label>
        <input id="dataInicio" type="date">
        <input id="dataFim" type="date">
        <button id="btnFiltrarData" class="secondary">Aplicar Data</button>
      </div>

      <div style="width:100%; margin-top:8px; display:flex; gap:12px; align-items:center; justify-content:space-between;">
        <div class="small">Cache local (IndexedDB): <span id="cacheStatus">desconhecido</span></div>
        <div class="controls-inline">
          <button id="btnFetchAll" class="btn-ghost">Usar todos os concursos dispon√≠veis (1 ‚Üí √∫ltimo)</button>
          <button id="btnClearCache" class="btn-ghost">Limpar cache</button>
          <button id="btnLimparExpirado" class="btn-ghost" title="Remover cache com mais de 180 dias">Limpar cache (>180d)</button>
        </div>
      </div>

    </div>

    <div id="loading" class="small"></div>
    <div class="progress" style="display:none"><i id="progressBar"></i></div>

    <div class="panel">
      <h2>üìà Estat√≠sticas</h2>
      <div id="estatisticas" class="stats"></div>
      <div id="graficoWrapper"><canvas id="grafico"></canvas></div>
    </div>

    <div class="panel">
      <h2>üéØ Resultados (lista)</h2>
      <div class="small">Clique em uma combina√ß√£o sugerida para destac√°-la na lista / gr√°fico.</div>
      <div id="tabelaResultados"></div>
      <div style="margin-top:8px;">
        <button id="btnExportCSV">Exportar concursos (CSV)</button>
      </div>
    </div>

    <div class="panel">
      <h2>üîÆ An√°lise Preditiva e Gera√ß√£o</h2>
      <div id="analiseProb" class="small"></div>

      <div style="margin-top:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <label>Quantidade de apostas: <input id="qtdApostas" type="number" value="5" min="1" max="50" style="width:70px"></label>
        <label>Tamanho aposta: <input id="tamanhoAposta" type="number" value="6" min="1" style="width:70px"></label>
        <button id="btnGerarOtimizadas">Gerar Combina√ß√µes Otimizadas</button>
        <button id="btnExportComb" class="secondary">Exportar combina√ß√µes (CSV)</button>
      </div>

      <div id="combinacoesOtimizadas"></div>
    </div>

    <div class="panel">
      <h2>üî¨ Matriz de Coocorr√™ncia (visual)</h2>
      <div id="heatmap" class="small"></div>
    </div>

  </div>

  <script>
  /*************************************************************************
   *  IndexedDB simple wrapper (robusto)
   *************************************************************************/
  const DB_NAME = 'loterias_cache_v1';
  const DB_STORE = 'concurso_store'; // key: `${tipo}:${numero}`, value: objeto concurso
  let dbPromise = null;

  function openDB() {
    if (dbPromise) return dbPromise;
    dbPromise = new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, 1);
      req.onupgradeneeded = (e) => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains(DB_STORE)) {
          db.createObjectStore(DB_STORE, { keyPath: 'key' });
        }
      };
      req.onsuccess = e => resolve(e.target.result);
      req.onerror = e => reject(e.target.error);
    });
    return dbPromise;
  }

  async function idbPut(key, value) {
    const db = await openDB();
    return new Promise((res, rej) => {
      const tx = db.transaction(DB_STORE, 'readwrite');
      const store = tx.objectStore(DB_STORE);
      store.put({ key, value, ts: Date.now() });
      tx.oncomplete = () => res(true);
      tx.onerror = e => rej(e);
    });
  }

  async function idbGet(key) {
    const db = await openDB();
    return new Promise((res, rej) => {
      const tx = db.transaction(DB_STORE, 'readonly');
      const store = tx.objectStore(DB_STORE);
      const r = store.get(key);
      r.onsuccess = () => res(r.result ? r.result.value : null);
      r.onerror = e => rej(e);
    });
  }

  async function idbClear() {
    const db = await openDB();
    return new Promise((res, rej) => {
      const tx = db.transaction(DB_STORE,'readwrite');
      tx.objectStore(DB_STORE).clear();
      tx.oncomplete = () => res(true);
      tx.onerror = e => rej(e);
    });
  }

  async function idbKeysPrefix(prefix) {
    const db = await openDB();
    return new Promise((res, rej) => {
      const tx = db.transaction(DB_STORE,'readonly');
      const store = tx.objectStore(DB_STORE);
      const req = store.openCursor();
      const keys = [];
      req.onsuccess = e => {
        const cur = e.target.result;
        if (!cur) { res(keys); return; }
        if (cur.key && cur.key.startsWith(prefix)) keys.push(cur.key);
        cur.continue();
      };
      req.onerror = e => rej(e);
    });
  }

  async function idbDelete(key) {
    const db = await openDB();
    return new Promise((res, rej) => {
      const tx = db.transaction(DB_STORE,'readwrite');
      tx.objectStore(DB_STORE).delete(key);
      tx.oncomplete = () => res(true);
      tx.onerror = e => rej(e);
    });
  }

  async function limparCacheExpirado(days = 180) {
    const cutoff = Date.now() - days * 24 * 3600 * 1000;
    const db = await openDB();
    return new Promise((res, rej) => {
      const tx = db.transaction(DB_STORE, 'readwrite');
      const store = tx.objectStore(DB_STORE);
      const req = store.openCursor();
      req.onsuccess = e => {
        const cur = e.target.result;
        if (!cur) { res(true); return; }
        const rec = cur.value;
        if (rec && rec.ts && rec.ts < cutoff) {
          cur.delete();
        }
        cur.continue();
      };
      req.onerror = e => rej(e);
    });
  }

  /*************************************************************************
   *  Config Loterias - CORRE√á√ÉO PARA LOTOMANIA
   *************************************************************************/
  const cfgLoterias = {
    lotofacil: { nome: 'Lotof√°cil', max:25, api:'lotofacil', defaultSize:15 },
    megasena:  { nome: 'Mega-Sena', max:60, api:'megasena', defaultSize:6 },
    quina:     { nome: 'Quina', max:80, api:'quina', defaultSize:5 },
    lotomania: { nome: 'Lotomania', max:100, api:'lotomania', defaultSize:20 } // CORRE√á√ÉO: 20 n√∫meros sorteados, n√£o 50
  };

  let cfgAtual = cfgLoterias['megasena'];
  let ultimosSorteios = []; // array de {concurso, data, dezenas}
  let statsGlobais = [];
  let coocMatrix = []; // NxN
  let ultimoScores = []; // array N with scores used to generate

  // DOM
  const tipoSel = document.getElementById('tipoLoteria');
  const inicioInput = document.getElementById('concursoInicio');
  const fimInput = document.getElementById('concursoFim');
  const dataInicio = document.getElementById('dataInicio');
  const dataFim = document.getElementById('dataFim');
  const btnAtualizar = document.getElementById('btnAtualizar');
  const btnFiltrarData = document.getElementById('btnFiltrarData');
  const btnFetchAll = document.getElementById('btnFetchAll');
  const btnClearCache = document.getElementById('btnClearCache');
  const btnLimparExpirado = document.getElementById('btnLimparExpirado');
  const loadingText = document.getElementById('loading');
  const progressBar = document.getElementById('progressBar');
  const progressWrap = document.querySelector('.progress');
  const estatisticasDiv = document.getElementById('estatisticas');
  const tabelaResultados = document.getElementById('tabelaResultados');
  const graficoCanvas = document.getElementById('grafico');
  const analiseProb = document.getElementById('analiseProb');
  const combinacoesDiv = document.getElementById('combinacoesOtimizadas');
  const heatmapDiv = document.getElementById('heatmap');
  const btnExportCSV = document.getElementById('btnExportCSV');
  const btnGerarOtimizadas = document.getElementById('btnGerarOtimizadas');
  const btnExportComb = document.getElementById('btnExportComb');
  const qtdApostasInput = document.getElementById('qtdApostas');
  const tamanhoApostaInput = document.getElementById('tamanhoAposta');
  const ultimosNInput = document.getElementById('ultimosN');

  tipoSel.addEventListener('change', () => {
    cfgAtual = cfgLoterias[tipoSel.value];
    tamanhoApostaInput.value = cfgAtual.defaultSize;
    atualizarCacheStatus();
  });

  btnAtualizar.addEventListener('click', carregarIntervalo);
  btnFiltrarData.addEventListener('click', filtrarPorData);
  btnFetchAll.addEventListener('click', fetchAllConcursos);
  btnClearCache.addEventListener('click', async () => {
    if (!confirm('Limpar cache local dos concursos?')) return;
    await idbClear();
    atualizarCacheStatus();
    alert('Cache limpo.');
  });
  btnLimparExpirado.addEventListener('click', async () => {
    if (!confirm('Remover do cache registros com mais de 180 dias?')) return;
    await limparCacheExpirado(180);
    atualizarCacheStatus();
    alert('Cache antigo removido.');
  });

  btnExportCSV.addEventListener('click', exportConcursosCSV);
  btnGerarOtimizadas.addEventListener('click', () => gerarCombinacoesOtimizadas());
  btnExportComb.addEventListener('click', exportCombCSV);

  // Chart
  let chartInstance = null;

  /*************************************************************************
   *  Fetch helpers (Caixa API) - CORRE√á√ÉO ESPEC√çFICA PARA LOTOMANIA
   *************************************************************************/
  async function fetchConcurso(tipoApi, numero) {
    const url = `https://servicebus2.caixa.gov.br/portaldeloterias/api/${tipoApi}/${numero}`;
    try {
      const resp = await fetch(url, { headers: { "Accept": "application/json, text/plain, */*" } });
      if (!resp.ok) {
        console.warn(`fetchConcurso ${tipoApi}/${numero} -> ${resp.status}`);
        return null;
      }
      const raw = await resp.json();
      
      // TRATAMENTO ESPEC√çFICO PARA LOTOMANIA
      if (tipoApi === 'lotomania') {
        let dezenas = null;
        
        // Tentar diferentes formatos poss√≠veis para Lotomania
        if (raw.listaDezenas && Array.isArray(raw.listaDezenas)) {
          dezenas = raw.listaDezenas;
        } else if (raw.dezenas && Array.isArray(raw.dezenas)) {
          dezenas = raw.dezenas;
        } else if (raw.listaDezenasOrd && Array.isArray(raw.listaDezenasOrd)) {
          dezenas = raw.listaDezenasOrd;
        } else if (raw.dezenasSorteadasOrdemSorteio && Array.isArray(raw.dezenasSorteadasOrdemSorteio)) {
          dezenas = raw.dezenasSorteadasOrdemSorteio;
        } else if (raw.listaDezenasSorteadas && Array.isArray(raw.listaDezenasSorteadas)) {
          dezenas = raw.listaDezenasSorteadas;
        }
        
        // Fallback: buscar qualquer array com n√∫meros
        if (!dezenas) {
          for (const k in raw) {
            if (Array.isArray(raw[k]) && raw[k].length > 0) {
              const allNum = raw[k].every(v => (typeof v === 'number') || (typeof v === 'string' && /^\d+$/.test(v)));
              if (allNum) { 
                dezenas = raw[k]; 
                break; 
              }
            }
          }
        }

        if (!dezenas) {
          console.warn('Formato inesperado para Lotomania', numero, raw);
          return null;
        }

        // CONVERS√ÉO ESPEC√çFICA PARA LOTOMANIA: n√∫meros de 0-99
        const dezenasConvertidas = dezenas.map(d => {
          const num = parseInt(d, 10);
          // Lotomania usa n√∫meros de 0 a 99, converter para 1-100 se necess√°rio
          return num >= 0 && num <= 99 ? num : num;
        }).filter(d => !isNaN(d));

        return { 
          numero: raw.numero || numero, 
          dataApuracao: raw.dataApuracao || raw.data || raw.dataSorteio || null, 
          listaDezenas: dezenasConvertidas 
        };
      } else {
        // C√ìDIGO ORIGINAL PARA OUTRAS LOTERIAS
        let dezenas = null;
        if (raw.listaDezenas && Array.isArray(raw.listaDezenas)) dezenas = raw.listaDezenas;
        else if (raw.dezenas && Array.isArray(raw.dezenas)) dezenas = raw.dezenas;
        else if (raw.listaDezenasOrd && Array.isArray(raw.listaDezenasOrd)) dezenas = raw.listaDezenasOrd;
        else if (raw.dezenasSorteadasOrdemSorteio && Array.isArray(raw.dezenasSorteadasOrdemSorteio)) dezenas = raw.dezenasSorteadasOrdemSorteio;
        else if (raw.listaDezenasSorteadas && Array.isArray(raw.listaDezenasSorteadas)) dezenas = raw.listaDezenasSorteadas;

        if (!dezenas) {
          for (const k in raw) {
            if (Array.isArray(raw[k]) && raw[k].length > 0) {
              const allNum = raw[k].every(v => (typeof v === 'number') || (typeof v === 'string' && /^\d+$/.test(v)));
              if (allNum) { dezenas = raw[k]; break; }
            }
          }
        }

        if (!dezenas) {
          console.warn('Formato inesperado para', tipoApi, numero, raw);
          return null;
        }

        return { 
          numero: raw.numero || numero, 
          dataApuracao: raw.dataApuracao || raw.data || raw.dataSorteio || null, 
          listaDezenas: dezenas 
        };
      }
    } catch (err) {
      console.warn('Erro fetchConcurso', url, err);
      return null;
    }
  }

  async function fetchUltimoConcurso(tipoApi) {
    const url = `https://servicebus2.caixa.gov.br/portaldeloterias/api/${tipoApi}`;
    const resp = await fetch(url, { headers: { "Accept": "application/json, text/plain, */*" } });
    if (!resp.ok) throw new Error(`Erro ${resp.status}`);
    return await resp.json();
  }

  /*************************************************************************
   *  Cache helpers + util
   *************************************************************************/
  function cacheKey(tipo, numero) { return `${tipo}:${numero}`; }

  async function carregarIntervalo() {
    try {
      cfgAtual = cfgLoterias[tipoSel.value];
      let inicio = parseInt(inicioInput.value);
      let fim = parseInt(fimInput.value);

      const ultN = parseInt(ultimosNInput.value) || 0;

      if ((!inicio || !fim) && ultN) {
        const ultimo = await fetchUltimoConcurso(cfgAtual.api);
        fim = ultimo.numero;
        inicio = Math.max(1, fim - Math.max(1, ultN - 1));
        inicioInput.value = inicio;
        fimInput.value = fim;
      } else if (!inicio || !fim) {
        const ultimo = await fetchUltimoConcurso(cfgAtual.api);
        fim = ultimo.numero;
        inicio = Math.max(1, fim - 20);
        inicioInput.value = inicio;
        fimInput.value = fim;
      }

      if (inicio > fim) { alert('Concurso in√≠cio > concurso fim'); return; }

      loadingText.innerText = `Buscando concursos ${inicio} ‚Üí ${fim} ...`;
      progressWrap.style.display = 'block';
      progressBar.style.width = '0%';

      const arr = [];
      const total = fim - inicio + 1;
      let loaded = 0;
      for (let n = inicio; n <= fim; n++) {
        const key = cacheKey(cfgAtual.api, n);
        let data = await idbGet(key);
        if (!data) {
          const raw = await fetchConcurso(cfgAtual.api, n);
          if (raw) {
            data = { numero: raw.numero, dataApuracao: raw.dataApuracao, listaDezenas: raw.listaDezenas };
            try { await idbPut(key, data); } catch(e){ }
          } else {
            data = null;
          }
        }
        if (data && Array.isArray(data.listaDezenas)) {
          // TRATAMENTO ESPECIAL PARA LOTOMANIA - converter n√∫meros
          let dezenasProcessadas;
          if (cfgAtual.api === 'lotomania') {
            // Lotomania: n√∫meros de 0-99, garantir que est√£o no range correto
            dezenasProcessadas = data.listaDezenas
              .map(x => {
                const num = parseInt(x, 10);
                return isNaN(num) ? null : num;
              })
              .filter(x => x !== null && x >= 0 && x <= 99)
              .sort((a, b) => a - b);
          } else {
            // Outras loterias: n√∫meros de 1 em diante
            dezenasProcessadas = data.listaDezenas
              .map(x => parseInt(x, 10))
              .filter(x => !isNaN(x) && x >= 1 && x <= cfgAtual.max)
              .sort((a, b) => a - b);
          }
          
          if (dezenasProcessadas.length > 0) {
            arr.push({ 
              concurso: data.numero, 
              data: data.dataApuracao, 
              dezenas: dezenasProcessadas 
            });
          }
        }
        loaded++;
        progressBar.style.width = `${Math.round((loaded/total)*100)}%`;
      }
      progressWrap.style.display = 'none';
      loadingText.innerText = '';
      ultimosSorteios = arr.sort((a,b)=>a.concurso - b.concurso);
      processarDadosEExibir();
      atualizarCacheStatus();
    } catch (e) {
      console.error(e);
      alert('Erro ao carregar intervalo. Veja console.');
      progressWrap.style.display = 'none';
      loadingText.innerText = '';
    }
  }

  async function filtrarPorData() {
    const di = dataInicio.value;
    const df = dataFim.value;
    if (!di || !df) { alert('Informe data in√≠cio e fim'); return; }
    const start = new Date(di);
    const end = new Date(df);
    if (start > end) { alert('Data in√≠cio maior que fim'); return; }

    cfgAtual = cfgLoterias[tipoSel.value];
    const keys = await idbKeysPrefix(cfgAtual.api + ':');
    let arr = [];
    for (const k of keys) {
      const val = await idbGet(k);
      if (!val) continue;
      const d = new Date(val.dataApuracao);
      if (d >= start && d <= end) {
        // APLICAR MESMO TRATAMENTO DE CONVERS√ÉO
        let dezenasProcessadas;
        if (cfgAtual.api === 'lotomania') {
          dezenasProcessadas = val.listaDezenas
            .map(x => {
              const num = parseInt(x, 10);
              return isNaN(num) ? null : num;
            })
            .filter(x => x !== null && x >= 0 && x <= 99)
            .sort((a, b) => a - b);
        } else {
          dezenasProcessadas = val.listaDezenas
            .map(x => parseInt(x, 10))
            .filter(x => !isNaN(x) && x >= 1 && x <= cfgAtual.max)
            .sort((a, b) => a - b);
        }
        
        if (dezenasProcessadas.length > 0) {
          arr.push({ 
            concurso: val.numero, 
            data: val.dataApuracao, 
            dezenas: dezenasProcessadas 
          });
        }
      }
    }

    if (arr.length === 0) {
      const ultimo = await fetchUltimoConcurso(cfgAtual.api);
      const fim = ultimo.numero;
      const inicio = Math.max(1, fim - 400);
      loadingText.innerText = 'Buscando concursos para filtrar por data (pode demorar)...';
      progressWrap.style.display = 'block';
      progressBar.style.width = '0%';
      const temp = [];
      let loaded = 0;
      for (let n = inicio; n <= fim; n++) {
        let raw = await idbGet(cacheKey(cfgAtual.api, n));
        if (!raw) {
          try { 
            raw = await fetchConcurso(cfgAtual.api, n); 
            if (raw) await idbPut(cacheKey(cfgAtual.api, n), raw); 
          } catch(e) {}
        }
        if (raw) {
          const dd = new Date(raw.dataApuracao);
          if (dd >= start && dd <= end) {
            let dezenasProcessadas;
            if (cfgAtual.api === 'lotomania') {
              dezenasProcessadas = raw.listaDezenas
                .map(x => {
                  const num = parseInt(x, 10);
                  return isNaN(num) ? null : num;
                })
                .filter(x => x !== null && x >= 0 && x <= 99)
                .sort((a, b) => a - b);
            } else {
              dezenasProcessadas = raw.listaDezenas
                .map(x => parseInt(x, 10))
                .filter(x => !isNaN(x) && x >= 1 && x <= cfgAtual.max)
                .sort((a, b) => a - b);
            }
            
            if (dezenasProcessadas.length > 0) {
              temp.push({ 
                concurso: raw.numero, 
                data: raw.dataApuracao, 
                dezenas: dezenasProcessadas 
              });
            }
          }
        }
        loaded++;
        progressBar.style.width = `${Math.round((loaded/(fim-inicio+1))*100)}%`;
      }
      progressWrap.style.display = 'none';
      loadingText.innerText = '';
      arr = temp;
    }

    ultimosSorteios = arr.sort((a,b)=>a.concurso-b.concurso);
    processarDadosEExibir();
    atualizarCacheStatus();
  }

  async function fetchAllConcursos() {
    if (!confirm('Isto ir√° baixar muitos concursos (um por um) e armazenar em seu navegador. Deseja continuar?')) return;
    cfgAtual = cfgLoterias[tipoSel.value];
    const ultimo = await fetchUltimoConcurso(cfgAtual.api);
    const fim = ultimo.numero;
    const inicio = 1;
    loadingText.innerText = `Baixando todos os concursos 1 ‚Üí ${fim} (cache progressivo). Pode demorar.`;
    progressWrap.style.display = 'block';
    const batch = 25;
    let loaded = 0;

    for (let s = inicio; s <= fim; s += batch) {
      const promises = [];
      for (let n = s; n < s + batch && n <= fim; n++) {
        const key = cacheKey(cfgAtual.api, n);
        promises.push((async () => {
          const existing = await idbGet(key);
          if (!existing) {
            try {
              const raw = await fetchConcurso(cfgAtual.api, n);
              if (raw) await idbPut(key, { numero: raw.numero, dataApuracao: raw.dataApuracao, listaDezenas: raw.listaDezenas });
            } catch (err) {
            }
          }
        })());
      }
      await Promise.all(promises);
      loaded = Math.min(fim, s + batch - 1);
      progressBar.style.width = `${Math.round((loaded/fim) * 100)}%`;
    }

    progressWrap.style.display = 'none';
    loadingText.innerText = 'Conclu√≠do download total (cache). Voc√™ pode agora filtrar ou usar "Carregar intervalo".';
    atualizarCacheStatus();
  }

  async function atualizarCacheStatus() {
    const keys = await idbKeysPrefix((cfgLoterias[tipoSel.value].api || '') + ':');
    document.getElementById('cacheStatus').innerText = keys.length ? `${keys.length} itens em cache` : 'vazio';
  }

  /*************************************************************************
   *  Processamento de dados - CORRE√á√ÉO PARA LOTOMANIA
   *************************************************************************/
  function processarDadosEExibir() {
    if (!ultimosSorteios || ultimosSorteios.length === 0) {
      estatisticasDiv.innerHTML = '<div class="small">Nenhum concurso carregado.</div>';
      tabelaResultados.innerHTML = '';
      analiseProb.innerHTML = '';
      combinacoesDiv.innerHTML = '';
      heatmapDiv.innerHTML = '';
      if (chartInstance) { chartInstance.destroy(); chartInstance = null; }
      return;
    }
    
    const N = cfgAtual.max;
    const freq = Array(N).fill(0);
    const matrix = Array.from({length:N}, ()=>Array(N).fill(0));
    const total = ultimosSorteios.length;

    ultimosSorteios.forEach(s => {
      s.dezenas.forEach(d1 => {
        // AJUSTE PARA LOTOMANIA: n√∫meros de 0-99 vs √≠ndice 0-99
        const idx1 = cfgAtual.api === 'lotomania' ? d1 : d1 - 1;
        if (idx1 >= 0 && idx1 < N) {
          freq[idx1]++;
          s.dezenas.forEach(d2 => {
            if (d1 !== d2) {
              const idx2 = cfgAtual.api === 'lotomania' ? d2 : d2 - 1;
              if (idx2 >= 0 && idx2 < N) {
                matrix[idx1][idx2]++;
              }
            }
          });
        }
      });
    });

    statsGlobais = freq;
    coocMatrix = matrix;

    // scores por dezena
    const p = freq.map(f => f / total);
    const p2 = matrix.map(l => l.map(v => v/total));
    const associacao = Array(N).fill(0);
    for (let i=0;i<N;i++){
      let soma=0, cont=0;
      for (let j=0;j<N;j++){
        if (i!==j && p[i]>0 && p[j]>0) { soma += p2[i][j]/(p[i]*p[j]); cont++; }
      }
      associacao[i] = cont ? soma/cont : 1;
    }
    const scores = freq.map((f,i) => f * associacao[i]);
    ultimoScores = scores;

    renderEstatisticas(freq);
    renderResultados(ultimosSorteios);
    renderGrafico(freq);
    renderAnaliseSummary(total, freq, scores);
    renderHeatmap(matrix, freq);
  }

  /*************************************************************************
   *  Renderers - CORRE√á√ÉO PARA EXIBI√á√ÉO LOTOMANIA
   *************************************************************************/
  function renderEstatisticas(freq) {
    const N = cfgAtual.max;
    let html = '';
    for (let i=0;i<N;i++){
      // LOTOMANIA: mostrar n√∫meros de 0-99, outras: 1-60, 1-80, etc.
      const numeroDisplay = cfgAtual.api === 'lotomania' ? 
        String(i).padStart(2,'0') : 
        String(i+1).padStart(2,'0');
      html += `<div class="stat-item"><div style="font-size:14px">${numeroDisplay}</div><div style="font-size:12px">${freq[i]}x</div></div>`;
    }
    estatisticasDiv.innerHTML = html;
  }

  function renderResultados(arr) {
    let html = `<table><tr><th>Concurso</th><th>Data</th><th>Dezenas</th></tr>`;
    arr.slice().reverse().forEach(s => {
      html += `<tr><td>${s.concurso}</td><td>${s.data}</td><td>${
        s.dezenas.map(d => {
          // LOTOMANIA: n√∫meros j√° est√£o 0-99, outras: 1-60, 1-80, etc.
          const displayNum = cfgAtual.api === 'lotomania' ? 
            String(d).padStart(2,'0') : 
            String(d).padStart(2,'0');
          return `<span class="dezena">${displayNum}</span>`;
        }).join('')
      }</td></tr>`;
    });
    html += `</table>`;
    tabelaResultados.innerHTML = html;
  }

  function renderGrafico(freq) {
    const labels = freq.map((_,i) => 
      cfgAtual.api === 'lotomania' ? 
        String(i).padStart(2,'0') : 
        String(i+1).padStart(2,'0')
    );
    const data = freq;
    if (chartInstance) chartInstance.destroy();
    const bgArray = data.map(_ => '#2196f3');
    chartInstance = new Chart(graficoCanvas.getContext('2d'), {
      type:'bar',
      data:{ labels, datasets:[{ label:'Frequ√™ncia', data, backgroundColor:bgArray }]},
      options:{ responsive:true, plugins:{ legend:{display:false} }, scales:{ x:{ticks:{maxRotation:0,minRotation:0}} } }
    });
  }

  function renderAnaliseSummary(total, freq, scores) {
    const N = cfgAtual.max;
    const arr = scores.map((s,i)=>({
      num: cfgAtual.api === 'lotomania' ? i : i + 1,
      score: s,
      freq: freq[i]
    }));
    arr.sort((a,b)=>b.score-a.score);
    const topk = arr.slice(0,cfgAtual.defaultSize).map(x=>x.num);

    let html = `<div><b>Concursos analisados:</b> ${total}</div>`;
    html += `<div style="margin-top:8px;"><b>Dezenas mais prov√°veis (score ajustado):</b> ${
      topk.map(d => {
        const displayNum = cfgAtual.api === 'lotomania' ? 
          String(d).padStart(2,'0') : 
          String(d).padStart(2,'0');
        return `<span class="dezena highlight">${displayNum}</span>`;
      }).join(' ')
    }</div>`;
    analiseProb.innerHTML = html;
  }

  function renderHeatmap(matrix, freq) {
    const N = cfgAtual.max;
    const total = ultimosSorteios.length;
    const pairs = [];
    for (let i=0;i<N;i++){
      for (let j=i+1;j<N;j++){
        const val = (matrix[i][j] + matrix[j][i]) / total;
        pairs.push({ 
          a: cfgAtual.api === 'lotomania' ? i : i + 1, 
          b: cfgAtual.api === 'lotomania' ? j : j + 1, 
          v: val 
        });
      }
    }
    pairs.sort((a,b)=>b.v - a.v);
    const top = pairs.slice(0,30);
    let html = `<div><b>Top pares por coocorr√™ncia (frequ√™ncia conjunta)</b></div><div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;">`;
    top.forEach(p => {
      const displayA = cfgAtual.api === 'lotomania' ? 
        String(p.a).padStart(2,'0') : 
        String(p.a).padStart(2,'0');
      const displayB = cfgAtual.api === 'lotomania' ? 
        String(p.b).padStart(2,'0') : 
        String(p.b).padStart(2,'0');
      html += `<div style="padding:6px;border-radius:6px;background:#fff">${displayA}-${displayB} <div class="small"> ${p.v.toFixed(3)}</div></div>`;
    });
    html += `</div>`;
    heatmapDiv.innerHTML = html;
  }

  /*************************************************************************
   *  Gerador autom√°tico - CORRE√á√ÉO PARA LOTOMANIA
   *************************************************************************/
  function sampleWithoutReplacementWeighted(weights, k) {
    const items = weights.map(x=>({ ...x }));
    const chosen = [];
    for (let r=0;r<k && items.length>0;r++){
      const sum = items.reduce((s,it)=>s+it.w,0);
      if (sum <= 0) {
        const idx = Math.floor(Math.random()*items.length);
        chosen.push(items[idx].num);
        items.splice(idx,1);
        continue;
      }
      let x = Math.random() * sum;
      let idx = 0;
      while (x > items[idx].w && idx < items.length-1) {
        x -= items[idx].w;
        idx++;
      }
      chosen.push(items[idx].num);
      items.splice(idx,1);
    }
    return chosen.sort((a,b)=>a-b);
  }

  function calcularScoreComb(comb) {
    const N = cfgAtual.max;
    // CORRE√á√ÉO: √≠ndices para Lotomania vs outras loterias
    const idxs = comb.map(d => cfgAtual.api === 'lotomania' ? d : d - 1);
    const sumInd = idxs.reduce((s,i)=>s + (ultimoScores[i] || 0), 0);
    let sumPairs = 0, pairs=0;
    for (let i=0;i<idxs.length;i++){
      for (let j=i+1;j<idxs.length;j++){
        const v = (coocMatrix[idxs[i]][idxs[j]] + coocMatrix[idxs[j]][idxs[i]]) / 2;
        sumPairs += v;
        pairs++;
      }
    }
    const meanPairs = pairs ? (sumPairs / pairs) : 0;
    let gapsScore = 0;
    for (let i=1;i<comb.length;i++) gapsScore += Math.abs(comb[i] - comb[i-1]);
    const diversity = gapsScore / comb.length;
    const alpha = 1.0, beta = 0.6, gamma = 0.02;
    const score = alpha * sumInd + beta * meanPairs - gamma * (20 - diversity);
    return score;
  }

  async function gerarCombinacoesOtimizadas() {
    if (!ultimosSorteios.length) { alert('Carregue um intervalo primeiro.'); return; }
    const qtd = Math.max(1, Math.min(50, parseInt(qtdApostasInput.value) || 5));
    const k = Math.max(1, parseInt(tamanhoApostaInput.value) || cfgAtual.defaultSize);
    const N = cfgAtual.max;
    
    // CORRE√á√ÉO: base de weights considerando Lotomania
    const base = ultimoScores.map((s,i)=>({ 
      num: cfgAtual.api === 'lotomania' ? i : i + 1, 
      w: Math.max(0.00001, s) 
    }));
    
    const candidatesMap = new Map();
    const tries = Math.max(200, qtd * 150);
    for (let t=0;t<tries;t++){
      const comb = sampleWithoutReplacementWeighted(base, k);
      const key = comb.join(',');
      if (candidatesMap.has(key)) continue;
      const sc = calcularScoreComb(comb);
      candidatesMap.set(key, { comb, score: sc });
    }
    
    const arr = Array.from(candidatesMap.values()).sort((a,b)=>b.score - a.score).slice(0,qtd);
    combinacoesDiv.innerHTML = '';
    arr.forEach((t,i) => {
      const div = document.createElement('div');
      div.className = 'jogo';
      div.innerHTML = `<div><b>Jogo ${i+1}</b> &nbsp; ${
        t.comb.map(d => {
          const displayNum = cfgAtual.api === 'lotomania' ? 
            String(d).padStart(2,'0') : 
            String(d).padStart(2,'0');
          return `<span class="dezena">${displayNum}</span>`;
        }).join(' ')
      }</div>
                       <div class="small">score: ${t.score.toFixed(4)}</div>`;
      div.addEventListener('click', ()=> highlightCombination(t.comb));
      combinacoesDiv.appendChild(div);
    });
  }

  function highlightCombination(comb) {
    const html = `<table><tr><th>Concurso</th><th>Data</th><th>Dezenas</th></tr>` +
      ultimosSorteios.slice().reverse().map(s => {
        const str = s.dezenas.map(d => {
          const cls = comb.includes(d) ? 'dezena highlight' : 'dezena';
          const displayNum = cfgAtual.api === 'lotomania' ? 
            String(d).padStart(2,'0') : 
            String(d).padStart(2,'0');
          return `<span class="${cls}">${displayNum}</span>`;
        }).join('');
        return `<tr><td>${s.concurso}</td><td>${s.data}</td><td>${str}</td></tr>`;
      }).join('') + `</table>`;
    tabelaResultados.innerHTML = html;
    
    if (chartInstance) {
      const labels = chartInstance.data.labels;
      chartInstance.data.datasets[0].backgroundColor = labels.map((lab,i) => {
        const num = cfgAtual.api === 'lotomania' ? i : i + 1;
        return comb.includes(num) ? '#ff5722' : '#2196f3';
      });
      chartInstance.update();
      setTimeout(()=> {
        chartInstance.data.datasets[0].backgroundColor = chartInstance.data.labels.map(_=> '#2196f3');
        chartInstance.update();
        renderResultados(ultimosSorteios);
      }, 6000);
    }
  }

  /*************************************************************************
   *  Export helpers
   *************************************************************************/
  function exportConcursosCSV() {
    if (!ultimosSorteios.length) { alert('Nada a exportar'); return; }
    let csv = 'concurso,data,dezenas\n';
    ultimosSorteios.forEach(s => {
      const dataEsc = (''+s.data).replace(/"/g,'""');
      const dezEsc = (''+s.dezenas.join(' ')).replace(/"/g,'""');
      csv += `${s.concurso},"${dataEsc}","${dezEsc}"\n`;
    });
    downloadText(csv, `${cfgAtual.api}_concursos_${(new Date()).toISOString().replace(/[:.]/g,'-')}.csv`);
  }

  function exportCombCSV() {
    const nodes = combinacoesDiv.querySelectorAll('.jogo');
    if (!nodes.length) { alert('Gere combina√ß√µes antes.'); return; }
    let csv = 'jogo,dezenas,score\n';
    nodes.forEach((n,i) => {
      const dez = Array.from(n.querySelectorAll('.dezena')).map(s => s.innerText).join(' ');
      const score = n.querySelector('.small')?.innerText.replace('score: ','') || '';
      csv += `${i+1},"${dez.replace(/"/g,'""')}",${score}\n`;
    });
    downloadText(csv, `${cfgAtual.api}_combinacoes_${(new Date()).toISOString().replace(/[:.]/g,'-')}.csv`);
  }

  function downloadText(text, filename) {
    const blob = new Blob([text], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; document.body.appendChild(a); a.click();
    setTimeout(()=> { URL.revokeObjectURL(url); a.remove(); }, 2000);
  }

  /*************************************************************************
   *  Inicializa√ß√£o
   *************************************************************************/
  (async () => {
    cfgAtual = cfgLoterias[tipoSel.value];
    tamanhoApostaInput.value = cfgAtual.defaultSize;
    await atualizarCacheStatus();
    if ('serviceWorker' in navigator) {
      try { navigator.serviceWorker.register('service-worker.js').catch(()=>{}); } catch(e){}
    }
    try { await carregarIntervalo(); } catch(e) { console.warn('preload fail', e); }
  })();

  </script>
  <script>
// Registro do Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('/service-worker.js')
      .then(function(registration) {
        console.log('ServiceWorker registrado com sucesso: ', registration.scope);
        
        // Verificar atualiza√ß√µes
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          console.log('Nova vers√£o do Service Worker encontrada!');
          
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              // Nova vers√£o dispon√≠vel
              if (confirm('Nova vers√£o dispon√≠vel! Recarregar para atualizar?')) {
                window.location.reload();
              }
            }
          });
        });
      })
      .catch(function(error) {
        console.log('Falha no registro do ServiceWorker: ', error);
      });
  });

  // Ouvir mensagens do Service Worker
  navigator.serviceWorker.addEventListener('message', event => {
    console.log('Mensagem do Service Worker:', event.data);
    
    if (event.data && event.data.type === 'CACHE_UPDATED') {
      console.log('Cache atualizado:', event.data.payload);
    }
  });
}

// Detectar se est√° em modo standalone (PWA)
function isRunningStandalone() {
  return (window.matchMedia('(display-mode: standalone)').matches) || 
         (window.navigator.standalone) || 
         (document.referrer.includes('android-app://'));
}

// Aplicar l√≥gica espec√≠fica para PWA
if (isRunningStandalone()) {
  document.documentElement.classList.add('pwa-mode');
  console.log('Executando como PWA');
}
</script>

</body>
</html>